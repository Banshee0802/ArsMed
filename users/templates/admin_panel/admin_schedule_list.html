{% extends "profile/profile.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile/schedule.css' %}">
{% endblock %}

{% block content %}

<div class="admin-card">
    <h1 class="admin-title">Расписание</h1>

     <a href="{% url 'users:admin_schedule_add' %}" class="admin-btn add-btn">
        + Добавить расписание
    </a> 
    <!-- Фильтры -->
    <form method="get" class="filter-form">
        <select name="doctor">
            <option value="">Все врачи</option>
            {% for doc in doctors %}
                <option value="{{ doc.id }}" {% if request.GET.doctor == doc.id|stringformat:"s" %}selected{% endif %}>
                    {{ doc }}
                </option>
            {% endfor %}
        </select>

        <input type="date" name="date" value="{{ request.GET.date }}">

        <select name="status">
            <option value="">Все статусы</option>
            {% for value, label in status_choices %}
                <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>
                    {{ label }}
                </option>
            {% endfor %}
        </select>

        <button type="submit" class="filter-btn">Применить</button>
    </form>

   <hr>
    <form method="post" action="{% url 'users:admin_schedule_toggle_day' %}" class="day-toggle-form">
        {% csrf_token %}
        <select name="doctor" required>
            <option value="">Врач</option>
            {% for doc in doctors %}
                <option value="{{ doc.id }}">{{ doc }}</option>
            {% endfor %}
        </select>
        <input type="date" name="date" required>
        
        <button type="submit" name="action" value="close" class="delete-btn" onclick="return confirm('Закрыть смену?')">Закрыть день</button>
        <button type="submit" name="action" value="open"  class="open-btn"   onclick="return confirm('Открыть смену?')">Открыть день</button>
    </form>

  {% if schedules %}
    {% regroup schedules by doctor as by_doc %}

    {% for doc in by_doc %}
      <div class="doctor-card">
        <h2 class="doctor-header toggle-doctor" data-doctor-id="{{ forloop.counter }}">
          {{ doc.grouper }}
        </h2>

        <div class="doctor-slots hidden" id="doctor-{{ forloop.counter }}">
          {% regroup doc.list by date as by_date %}

          {% for day in by_date %}
            <div class="date-card">
              <h3 class="date-title">{{ day.grouper }}</h3>

              <div class="slots-grid">
                    {% for s in day.list %}
                        <div class="slot-card status-{{ s.status }}">
                        <div class="slot-time">{{ s.start_time }} — {{ s.end_time }}</div>

                        <div class="slot-info">
                            {% if s.status == 'closed' %}
                            <span class="badge closed">Закрыто</span>

                            {% elif s.status == 'available' %}
                            <span class="badge free">Свободно</span>

                            {% else %}
                            <span class="badge {{ s.status }}">
                                {% if s.status == 'booked' %}Ожидает
                                {% elif s.status == 'confirmed' %}Подтверждено
                                {% else %}Завершён{% endif %}
                            </span>
                            {% if s.booked_by %}
                                <div class="patient">
                                {{ s.booked_by.last_name|capfirst }} {{ s.booked_by.first_name|capfirst }} {{ s.booked_by.patronymic|capfirst }}
                                <br>{{ s.booked_by.phone }}
                                </div>
                            {% endif %}
                            {% endif %}
      </div>
                    <div class="slot-actions">
                      <a href="{% url 'users:admin_schedule_edit' s.id %}" class="btn small edit">✎</a>
                      <a href="{% url 'users:admin_schedule_delete' s.id %}" class="btn small delete">×</a>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}

  {% else %}
    <p class="empty">Нет расписаний</p>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/admin_schedule_toggle.js' %}"></script>
{% endblock %}
    